<!DOCTYPE html>
<html lang="zh-HK">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
	<title>‰øÑÁæÖÊñØÊñπÂ°ä Tetris</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			background: #0d0d0d;
			color: #fff;
			font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			padding: 12px 8px;
			overflow-x: hidden;
			-webkit-tap-highlight-color: transparent;
		}

		/* === ‰∏äÊñπË≥áË®äÂàó === */
		#top-panel {
			width: 100%;
			max-width: 400px;
			background: #1a1a1a;
			border: 3px solid #333;
			border-bottom: none;
			border-radius: 14px 14px 0 0;
			padding: 6px 14px;
			justify-content: space-between;
			align-items: center;
			gap: 12px;
		}
		#info {
			display: flex; justify-content: space-between; align-items: center;
			gap: 10px; margin: 0 0 8px 0; font-size: 0.95em; font-weight: bold;
		}
		#score-item {
			flex: 2; background: #222; padding: 6px 16px; border-radius: 6px;
			text-align: center; min-width: 120px;
		}
		#level-item {
			flex: 1; background: #222; padding: 6px 12px; border-radius: 6px;
			text-align: center; min-width: 70px;
		}
		#next-item {                                     /* ‚Üê Êñ∞Â¢û */
			flex: 1; background: #222; padding: 4px 8px; border-radius: 6px;
			text-align: center; min-width: 70px; position: relative;
		}
		#next-canvas {                                   /* ‚Üê Êñ∞Â¢û */
			width: 60px; height: 40px; display: block; margin: 0 auto;
			image-rendering: pixelated; image-rendering: crisp-edges;
		}
		.info-label { 
			opacity: 0.8; font-weight: normal;
		}
		#score, #level {
			font-weight: bold; font-size: 1.1em;
		}
		#restart-btn-top {
			background: #e91e63;
			color: white;
			border: none;
			border-radius: 10px;
			width: 48px;
			height: 48px;
			font-size: 1.5rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 2px 6px rgba(233,30,99,0.3);
			transition: all 0.15s ease;
		}
		#restart-btn-top:active {
			transform: scale(0.92);
			box-shadow: 0 1px 3px rgba(233,30,99,0.4);
		}

		/* === ÈÅäÊà≤Áï´Â∏É === */
		#game-canvas {
			width: 100%;
			max-width: 400px;
			background: #111;
			border: 3px solid #333;
			border-top: none;
			border-radius: 0 0 14px 14px;
			image-rendering: pixelated;
			image-rendering: crisp-edges;
			touch-action: none;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		}

		/* === ‰∏ãÊñπÊéßÂà∂ÂàóÔºà‰∏ÄË°åÔºâ=== */
		#bottom-panel {
			width: 100%;
			max-width: 400px;
			margin-top: 16px;
		}
		#controls {
			display: flex;
			justify-content: space-between;
			gap: 10px;
			padding: 0 6px;
		}
		.ctrl-btn {
			flex: 1;
			background: #00bcd4;
			color: #000;
			border: none;
			border-radius: 16px;
			height: 62px;
			font-size: 2rem;
			font-weight: bold;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 3px 8px rgba(0,188,212,0.25);
			transition: all 0.15s ease;
			min-width: 0;
		}
		.ctrl-btn:active {
			background: #00e5ff;
			transform: translateY(2px);
			box-shadow: 0 1px 4px rgba(0,188,212,0.3);
		}
		#pause-btn {
			background: #ff9800;
			flex: 1.1;
			font-size: 2.1rem;
		}
		#pause-btn.paused {
			background: #4caf50;
		}
		#pause-btn:active {
			background: #ffb74d;
		}
		#pause-btn.paused:active {
			background: #66bb6a;
		}

		/* === ÊâãÊ©üÂûÇÁõ¥ÂÑ™Âåñ === */
		@media (max-width: 480px) {
			body { padding: 10px 6px; }
			#top-panel { padding: 10px 12px; gap: 10px; }
			.info-item { padding: 7px 12px; }
			.info-label { font-size: 0.7rem; }
			#score, #level { font-size: 1.15rem; }
			#restart-btn-top { width: 44px; height: 44px; font-size: 1.4rem; }
			#next-canvas { width: 56px; height: 56px; }               /* ‚Üê ÊâãÊ©üÁ∏ÆÂ∞è */
			#controls { gap: 8px; }
			.ctrl-btn { height: 58px; font-size: 1.9rem; border-radius: 14px; }
			#pause-btn { font-size: 2rem; }
		}

		@media (max-width: 360px) {
			.info-label { font-size: 0.65rem; }
			#score, #level { font-size: 1.1rem; }
			.ctrl-btn { height: 54px; font-size: 1.75rem; }
			#next-canvas { width: 52px; height: 52px; }
		}
	</style>
</head>
<body>
	<div id="game">
		<!-- ÊúÄ‰∏äÊñπÔºöÂàÜÊï∏‰ΩîÊõ¥Â§öÁ©∫Èñì + Êñ∞Â¢û„Äå‰∏ã‰∏ÄÂÄã„ÄçÊ†ºÂ≠ê -->
		<div id="top-panel">
			<div id="info">
				<div id="score-item" class="info-item">
					<span class="info-label">ÂàÜÊï∏</span><span id="score">0</span>
				</div>
				<div id="level-item" class="info-item">
					<span class="info-label">Á≠âÁ¥ö</span><span id="level">1</span>
				</div>
				<div id="next-item" class="info-item">                     <!-- ‚Üê Êñ∞Â¢û -->
					<canvas id="next-canvas" width="80" height="80"></canvas>
				</div>
				<button id="restart-btn-top">‚è∫Ô∏è</button>
			</div>
		</div>

		<!-- ÈÅäÊà≤Áï´Â∏É -->
		<canvas id="game-canvas" width="400" height="500"></canvas>

		<!-- ‰∏ãÊñπÊéßÂà∂ -->
		<div id="bottom-panel">
			<div id="controls">
				<button class="ctrl-btn" id="left">‚¨ÖÔ∏è</button>
				<button class="ctrl-btn" id="rotate">üîÑ</button>
				<button class="ctrl-btn" id="right">‚û°Ô∏è</button>
				<button class="ctrl-btn" id="softdrop">‚¨áÔ∏è</button>
				<button class="ctrl-btn" id="harddrop">‚è¨</button>
				<button class="ctrl-btn" id="pause-btn">‚è∏Ô∏è</button>
			</div>
		</div>
	</div>

	<script>
		const canvas = document.getElementById('game-canvas');
		const ctx = canvas.getContext('2d');
		ctx.scale(20, 20);

		const nextCanvas = document.getElementById('next-canvas');          // ‚Üê Êñ∞Â¢û
		const nextCtx = nextCanvas.getContext('2d');
		nextCtx.scale(20, 20);                                              // ‚Üê Á∏ÆÂúñÂêåÊ®£ 20√ó20
		
		const scoreEl = document.getElementById('score');
		const levelEl = document.getElementById('level');
		const pauseBtn = document.getElementById('pause-btn');
		const restartBtnTop = document.getElementById('restart-btn-top');

		const ROW = 25;
		const COL = 20;
		const SQ = 1;
		const VACANT = 'black';

    // ÊñπÂ°äÂÆöÁæ©ÔºöÊØèÂÄãÊòØ [ÂΩ¢ÁãÄÈô£Âàó, È°èËâ≤]
		const PIECES = [
			[[[1,1,0],[0,1,1]], 'red'],
			[[[0,1,1],[1,1,0]], 'lime'],
			[[[0,1,0],[1,1,1]], 'purple'],
			[[[1,1],[1,1]], 'yellow'],
			[[[1,0,0],[1,1,1]], 'orange'],
			[[[1,1,1,1]], 'cyan'],
			[[[0,0,1],[1,1,1]], 'blue']
		];

		const ROTATIONS = {
			Z: [[[1,1,0],[0,1,1]], [[0,1],[1,1],[1,0]], [[1,1,0],[0,1,1]], [[0,1],[1,1],[1,0]]],
			S: [[[0,1,1],[1,1,0]], [[1,0],[1,1],[0,1]], [[0,1,1],[1,1,0]], [[1,0],[1,1],[0,1]]],
			T: [[[0,1,0],[1,1,1]], [[1,0],[1,1],[1,0]], [[1,1,1],[0,1,0]], [[0,1],[1,1],[0,1]]],
			O: [[[1,1],[1,1]], [[1,1],[1,1]], [[1,1],[1,1]], [[1,1],[1,1]]],
			L: [[[1,0,0],[1,1,1]], [[1,1],[1,0],[1,0]], [[1,1,1],[0,0,1]], [[0,1],[0,1],[1,1]]],
			I: [[[1,1,1,1]], [[1],[1],[1],[1]], [[1,1,1,1]], [[1],[1],[1],[1]]],
			J: [[[0,0,1],[1,1,1]], [[1,0],[1,0],[1,1]], [[1,1,1],[1,0,0]], [[1,1],[0,1],[0,1]]]
		};

		let board = Array.from({length: ROW}, () => Array(COL).fill(VACANT));
		let score = 0, level = 1;
		let dropStart = Date.now();
		let gameOver = false;
		let isPaused = false;
		let currentPiece = createPiece();
		let nextPiece = createPiece();                 // ‚Üê Êñ∞Â¢ûÔºö‰∏ã‰∏ÄÂÄãÊñπÂ°ä

		function createPiece() {
			const idx = Math.floor(Math.random() * PIECES.length);
			const [shape, color] = PIECES[idx];
			const type = ['Z','S','T','O','L','I','J'][idx];
			return {
				matrix: shape,
				color: color,
				type: type,
				x: Math.floor(COL / 2) - Math.floor(shape[0].length / 2),
				y: 0,
				rotation: 0
			};
		}

		// ----- Áπ™Ë£Ω‰∏ã‰∏ÄÂÄãÊñπÂ°äÔºàÁ∏ÆÂúñÔºâ -----
		function drawNextPiece() {
			nextCtx.fillStyle = '#111';
			nextCtx.fillRect(0, 0, 4, 4);               // 4√ó4 Ê†ºÂ≠êË∂≥Â§†È°ØÁ§∫ÊâÄÊúâÂΩ¢ÁãÄ
			const mat = nextPiece.matrix;
			const offsetX = (4 - mat[0].length) / 2;
			const offsetY = (4 - mat.length) / 2;
			mat.forEach((row, y) => {
				row.forEach((value, x) => {
					if (value) {
						nextCtx.fillStyle = nextPiece.color;
						nextCtx.fillRect(offsetX + x, offsetY + y, 1, 1);
						nextCtx.strokeStyle = 'rgba(0,0,0,0.3)';
						nextCtx.lineWidth = 0.08;
						nextCtx.strokeRect(offsetX + x, offsetY + y, 1, 1);
					}
				});
			});
		}

		function drawSquare(x, y, color) {
			ctx.fillStyle = color;
			ctx.fillRect(x, y, SQ, SQ);
			ctx.strokeStyle = 'rgba(0,0,0,0.3)';
			ctx.lineWidth = 0.08;
			ctx.strokeRect(x, y, SQ, SQ);
		}

		function drawBoard() {
			for (let r = 0; r < ROW; r++) {
				for (let c = 0; c < COL; c++) {
					drawSquare(c, r, board[r][c]);
				}
			}
		}

		function drawPiece() {
			currentPiece.matrix.forEach((row, y) => {
				row.forEach((value, x) => {
					if (value) {
						drawSquare(currentPiece.x + x, currentPiece.y + y, currentPiece.color);
					}
				});
			});
		}

		function collide() {
			for (let y = 0; y < currentPiece.matrix.length; y++) {
				for (let x = 0; x < currentPiece.matrix[y].length; x++) {
					if (currentPiece.matrix[y][x] &&
						(board[currentPiece.y + y] === undefined ||
						 board[currentPiece.y + y][currentPiece.x + x] === undefined ||
						 board[currentPiece.y + y][currentPiece.x + x] !== VACANT)) {
						return true;
					}
				}
			}
			return false;
		}

		function merge() {
			currentPiece.matrix.forEach((row, y) => {
				row.forEach((value, x) => {
					if (value) {
						board[currentPiece.y + y][currentPiece.x + x] = currentPiece.color;
					}
				});
			});
		}

		function rotate() {
			const nextRotation = (currentPiece.rotation + 1) % 4;
			const nextMatrix = ROTATIONS[currentPiece.type][nextRotation];
			const originalX = currentPiece.x;

      // ÂòóË©¶ÁâÜË∏¢Ôºàwall kickÔºâ
			const kicks = [0, 1, -1, 2, -2];
			for (const kick of kicks) {
				currentPiece.x = originalX + kick;
				currentPiece.matrix = nextMatrix;
				if (!collide()) {
					currentPiece.rotation = nextRotation;
					return;
				}
			}
			currentPiece.x = originalX; // ÈÇÑÂéü
		}

		function playerDrop() {
			currentPiece.y++;
			if (collide()) {
				currentPiece.y--;
				merge();
				clearLines();
				
				// ----- Áï∂ÂâçÊñπÂ°äËêΩÂú∞ ‚Üí ÊèõÊàê nextPiece -----
				currentPiece = nextPiece;
				currentPiece.x = Math.floor(COL / 2) - Math.floor(currentPiece.matrix[0].length / 2);
				currentPiece.y = 0;
				currentPiece.rotation = 0;

				nextPiece = createPiece();          // Áî¢ÁîüÊñ∞ÁöÑ‰∏ã‰∏ÄÂÄã
				drawNextPiece();                    // Êõ¥Êñ∞Á∏ÆÂúñ

				dropStart = Date.now();
				if (collide()) {
					gameOver = true;
					setTimeout(() => alert(`ÈÅäÊà≤ÁµêÊùüÔºÅ\nÊúÄÁµÇÂàÜÊï∏Ôºö${score}`), 100);
				}
			}
		}

		function playerHardDrop() {
			while (!collide()) currentPiece.y++;
			currentPiece.y--;
			playerDrop();
		}

		function playerMove(dir) {
			currentPiece.x += dir;
			if (collide()) currentPiece.x -= dir;
		}

		function clearLines() {
			let linesCleared = 0;
			outer: for (let y = ROW - 1; y >= 0; y--) {
				for (let x = 0; x < COL; x++) {
					if (!board[y][x] || board[y][x] === VACANT) continue outer;
				}
				board.splice(y, 1);
				board.unshift(Array(COL).fill(VACANT));
				linesCleared++;
				y++; // ÈáçÊñ∞Ê™¢Êü•ÈÄô‰∏ÄË°å
			}
			if (linesCleared > 0) {
				const points = [0, 100, 300, 500, 800];
				score += points[linesCleared] * level;
				level = Math.floor(score / 1000) + 1;
				updateScore();
			}
		}

		function updateScore() {
			scoreEl.textContent = score;
			levelEl.textContent = level;
		}

		function togglePause() {
			isPaused = !isPaused;
			pauseBtn.textContent = isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
			pauseBtn.classList.toggle('paused', isPaused);
		}

		function restartGame() {
			board = Array.from({length: ROW}, () => Array(COL).fill(VACANT));
			score = 0; level = 1;
			currentPiece = createPiece();
			nextPiece = createPiece();          // ÈáçÊñ∞Áî¢Áîü‰∏ã‰∏ÄÂÄã
			drawNextPiece();                    // È°ØÁ§∫
			gameOver = false;
			isPaused = false;
			pauseBtn.textContent = '‚è∏Ô∏è';
			pauseBtn.classList.remove('paused');
			updateScore();
			dropStart = Date.now();
			update();
		}

		function update() {
			if (gameOver || isPaused) {
				requestAnimationFrame(update);
				return;
			}

			ctx.fillStyle = '#111';
			ctx.fillRect(0, 0, COL, ROW);
			drawBoard();
			drawPiece();

			const now = Date.now();
			const dropInterval = Math.max(700, 1000 - (level - 1) * 100);
			if (now - dropStart > dropInterval) {
				playerDrop();
				dropStart = now;
			}

			requestAnimationFrame(update);
		}

		// === Ëß∏ÊéßÊéßÂà∂ ===
		document.getElementById('left').addEventListener('click', () => !gameOver && !isPaused && playerMove(-1));
		document.getElementById('right').addEventListener('click', () => !gameOver && !isPaused && playerMove(1));
		document.getElementById('rotate').addEventListener('click', () => !gameOver && !isPaused && rotate());
		document.getElementById('softdrop').addEventListener('click', () => !gameOver && !isPaused && playerDrop());

		document.getElementById('harddrop').addEventListener('click', () => {
			if (!gameOver && !isPaused) playerHardDrop();
		});

		// Èï∑ÊåâÂä†ÈÄü
		let softDropInterval;
		const softdropBtn = document.getElementById('softdrop');
		softdropBtn.addEventListener('touchstart', e => {
			e.preventDefault();
			if (gameOver || isPaused) return;
			playerDrop();
			softDropInterval = setInterval(() => !gameOver && !isPaused && playerDrop(), 50);
		});
		['touchend', 'mouseup', 'mouseleave'].forEach(ev => {
			softdropBtn.addEventListener(ev, () => clearInterval(softDropInterval));
		});

		pauseBtn.addEventListener('click', togglePause);
		restartBtnTop.addEventListener('click', restartGame);

		// === ÈçµÁõ§ÊéßÂà∂ ===
		document.addEventListener('keydown', e => {
			if (gameOver || isPaused) return;
			if (e.key === 'ArrowLeft') playerMove(-1);
			if (e.key === 'ArrowRight') playerMove(1);
			if (e.key === 'ArrowDown') playerDrop();
			if (e.key === 'ArrowUp') rotate();
			if (e.key === ' ') { e.preventDefault(); playerHardDrop(); }
			if (e.key === 'p' || e.key === 'P') togglePause();
			if (e.key === 'r' || e.key === 'R') restartGame();
		});

		// ÂàùÂßãÂåñ
		updateScore();
		drawNextPiece();          // È¶ñÊ¨°È°ØÁ§∫‰∏ã‰∏ÄÂÄãÊñπÂ°ä
		update();
	</script>
</body>
</html>